<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>70/30 Earnings</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    button{padding:10px 14px;border:0;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.1);cursor:pointer}
    #wallet{margin-top:16px;padding:12px;border:1px solid #ddd;border-radius:12px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:14px}
  </style>
</head>
<body>
  <h1>70/30 Earnings</h1>

  <div class="row" id="actions" style="display:none">
    <button id="btnSurveys">Open Surveys</button>
    <button id="btnWallet">Wallet</button>
    <button id="btnLogout">Logout</button>
  </div>

  <div id="wallet" style="display:none">
    <div><b>Balance:</b> <span id="balance">$0.00</span></div>
    <table>
      <thead><tr><th>ID</th><th>Source</th><th>Gross</th><th>Net</th><th>Status</th><th>When</th></tr></thead>
      <tbody id="txBody"></tbody>
    </table>
  </div>

  <div id="auth">
    <p><b>Logged out.</b> Please log in from your existing page (this file expects you already have login wired).</p>
  </div>

<script>
const BASE_URL = "https://seven030app-backend.onrender.com";

function centsToUSD(c){ return `$${(c/100).toFixed(2)}` }

async function api(path, opts={}){
  const token = localStorage.getItem("token");
  const headers = { "Content-Type":"application/json" };
  if (token) headers["Authorization"] = `Bearer ${token}`;
  const res = await fetch(`${BASE_URL}${path}`, { ...opts, headers });
  if (!res.ok) throw new Error(await res.text());
  return await res.json();
}

async function showWallet(){
  try{
    const data = await api("/api/wallet");
    document.getElementById("balance").textContent = centsToUSD(data.balance_cents);
    const tbody = document.getElementById("txBody");
    tbody.innerHTML = "";
    data.recent.forEach(tx=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${tx.id}</td>
                      <td>${tx.source}</td>
                      <td>${centsToUSD(tx.gross_cents)}</td>
                      <td>${centsToUSD(tx.net_cents)}</td>
                      <td>${tx.status}</td>
                      <td>${new Date(tx.created_at).toLocaleString()}</td>`;
      tbody.appendChild(tr);
    });
    document.getElementById("wallet").style.display = "block";
  }catch(e){
    alert("Wallet error: " + e.message);
  }
}

async function openSurveys(){
  try{
    const { url } = await api("/api/cpx/url");
    window.location.href = url;
  }catch(e){
    alert("Surveys error: " + e.message);
  }
}

function init(){
  const token = localStorage.getItem("token");
  const authed = !!token;
  document.getElementById("actions").style.display = authed ? "flex" : "none";
  document.getElementById("auth").style.display = authed ? "none" : "block";

  document.getElementById("btnSurveys").onclick = openSurveys;
  document.getElementById("btnWallet").onclick = showWallet;
  document.getElementById("btnLogout").onclick = ()=>{
    localStorage.removeItem("token");
    location.reload();
  };
}
init();
</script>
</body>
</html>
